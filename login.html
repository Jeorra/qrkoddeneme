<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Login</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f0f2f5; }
        #qr-container { text-align: center; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; }
        #qr-code { width: 250px; height: 250px; border: 1px solid #ddd; }
        #status { margin-top: 20px; font-size: 1.1em; color: #555; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="qr-container">
        <h1>Scan to Login</h1>
        <img id="qr-code" src="" alt="QR Code" />
        <p id="status">Please scan the QR code with your mobile app.</p>
        <p id="success-message" class="hidden">Login successful! Redirecting...</p>
    </div>

    <script>
        const qrCodeImage = document.getElementById('qr-code');
        const statusText = document.getElementById('status');
        const successMessage = document.getElementById('success-message');

        function connectWebSocket(sessionId) {
            // IMPORTANT: Use wss:// in production
            const socket = new WebSocket(`ws://localhost:8080?sessionId=${sessionId}`);

            socket.onopen = function(e) {
                console.log("[open] Connection established");
                statusText.textContent = 'Connection to server established. Waiting for scan...';
            };

            socket.onmessage = function(event) {
                console.log(`[message] Data received from server: ${event.data}`);
                const data = JSON.parse(event.data);

                if (data.event === 'loginSuccess') {
                    qrCodeImage.style.display = 'none';
                    statusText.style.display = 'none';
                    successMessage.style.display = 'block';
                    
                    setTimeout(() => {
                        alert(`Login successful for user ID: ${data.userId}. Token: ${data.token}`);
                        // In a real app, you would store the token and redirect:
                        // localStorage.setItem('authToken', data.token);
                        // window.location.href = '/dashboard.html';
                    }, 1000);
                }
            };

            socket.onclose = function(event) {
                if (event.wasClean) {
                    console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                } else {
                    console.error('[close] Connection died');
                    statusText.textContent = 'Connection lost. Please refresh the page.';
                }
            };

            socket.onerror = function(error) {
                console.error(`[error] ${error.message}`);
                statusText.textContent = 'Could not connect to the server. Please ensure it is running and refresh the page.';
            };
        }

        async function initializeLogin() {
            try {
                const response = await fetch('/api/session/new');
                if (!response.ok) {
                    throw new Error(`Failed to fetch session: ${response.statusText}`);
                }
                const sessionData = await response.json();

                qrCodeImage.src = sessionData.qrCodeUrl;
                connectWebSocket(sessionData.sessionId);

            } catch (error) {
                console.error("Initialization failed:", error);
                statusText.textContent = 'Failed to initialize login process. Please refresh the page.';
            }
        }

        // Automatically initialize the login process when the page loads.
        window.onload = initializeLogin;
    </script>
</body>
</html>
